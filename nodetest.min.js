"use strict";var admin_user="xxxxxxxxx";process.title="node-chat";var webSocketsServerPort=3e3,webSocketServer=require("websocket").server,http=require("http"),fs=require("fs"),url=require("url"),users_reg=[],users_onl=[],clients=[];fs.readFile("text/comments.txt","utf8",function(e,r){function t(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function s(){for(var e=JSON.stringify({type:"userupdate",names:users_onl}),r=0;r<clients.length;r++)clients[r].sendUTF(e)}if(e)return console.log("fs.readFile error: "+e);var o=JSON.parse(r),n=["red","green","blue","magenta","purple","plum","orange"];n.sort(function(e,r){return Math.random()>.5});var i=http.createServer(function(e,r){});i.listen(webSocketsServerPort,function(){console.log(new Date+" Server is listening on port "+webSocketsServerPort)});var l=new webSocketServer({httpServer:i});l.on("request",function(e){if(console.log(new Date+" Connection from origin "+e.origin+"."),"http://david.abotsi.com"===e.origin){console.log(new Date+" Connection accepted.");var r=e.accept("echo-protocol",e.origin),i=clients.push(r)-1,l=!1,a=!1;o.length>0&&r.sendUTF(JSON.stringify({type:"history",data:o})),r.on("message",function(e){if("utf8"===e.type)if(l===!1){var i=e.utf8Data,u=i.split("_")[0],c=i.slice(parseInt(u.length+1)),f=c.slice(parseInt(u));console.log(c),console.log(f),l=t(c.replace(f,"")),users_reg.indexOf(c)===-1&&users_reg.push(c),console.log(users_reg),l=l+"_"+users_reg.indexOf(c),console.log(admin_user);var g=c==admin_user;a=n.shift(),users_onl.push(l),r.sendUTF(JSON.stringify({type:"color",data:a,name:l,adm:g})),s()}else{console.log(new Date+" Received Message from "+l+": "+e.utf8Data);var p=l.slice(0,5)===admin_user.slice(0,5);if(p&&"order_to_save_message_file"===e.utf8Data)return console.log(e.utf8Data+" order to save message file // so i return"),void fs.writeFile("text/comments.txt",JSON.stringify(o),function(e){if(e)return console.log(e)});if(p&&"order_to_save_users_file"===e.utf8Data)return console.log(e.utf8Data+" order to save users file // so i return"),void fs.writeFile("text/users.txt",JSON.stringify(users_reg),function(e){if(e)return console.log(e)});var d={time:(new Date).getTime(),text:t(e.utf8Data),author:l,color:a};o.push(d),o=o.slice(-100);for(var v=JSON.stringify({type:"message",data:d}),_=0;_<clients.length;_++)clients[_].sendUTF(v)}}),r.on("close",function(e){l!==!1&&a!==!1&&(console.log("old users_onl array: "+users_onl),users_onl.indexOf(l)!==-1&&users_onl.splice(users_onl.indexOf(l),1),console.log("updated users_onl array: "+users_onl),clients.splice(i,1),n.push(a),s())})}}),console.log("Webserver wird acao ausgefÃ¼hrt.")});